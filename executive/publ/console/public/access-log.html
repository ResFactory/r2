<!DOCTYPE html>
<!-- follow guidelines in README.md, see FOUC section for why display:none is used-->
<html lang="en" style="display:none">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="./path.actuate.css" />
    <!-- $script used by component/ag-grid.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/script.js/2.5.9/script.min.js"></script>
    <script src="/universal-cc/component/ag-grid.js"></script>
    <script src="./universal.lib.js"></script>
    <script type="module">
        import { actuationStrategy } from "./path.lib.js";
        // prepare global `executive` and "bootstrap" or _actuate_ the page.
        const strategy = actuationStrategy().args;
        const executive = strategy.actuate();

        function tuiHook_isAccessLoggingEnabled(element, identity, uab) {
            const operationsEE = new EventEmitter();
            const hook = { identity, element, operationsEE };
            operationsEE.on("user-agent-server-response", (message) => {
                console.log('[tuiHook_isAccessLoggingEnabled.hook]', identity, 'user-agent-server-response', message);
                element.checked = message.state;
            });
            element.onchange = (evt) => {
                const message = { state: evt.srcElement.checked };
                operationsEE.emit("user-agent-request", message);
                console.log('[tuiHook_isAccessLoggingEnabled.hook]', identity, 'user-agent-request', message);
                // evt.srcElement.checked = !evt.srcElement.checked;
            }
            executive.consoleTunnel.addEventSourceEventListener("feature-state", (evt) => {
                const data = JSON.parse(evt.data);
                if (data && data.feature == "isAccessLoggingEnabled") {
                    element.checked = data.state;
                }
            });
            return hook;
        }

        const uab = new UserAgentBus({ clientReqMessageBaseURL: '/console/user-agent-bus' });
        document.querySelectorAll("[data-tunnel-ui]").forEach(e => uab.discoverDomElemHook(e, (token) => eval(token)));
        uab.init();

        executive.consoleTunnel.addEventSourceEventListener("log-access", (evt) => {
            if (accessLogAgGrid) {
                const data = JSON.parse(evt.data);
                accessLogAgGridConfig.api.applyTransaction({
                    add: [{
                        "date": new Date().toISOString(),
                        "status": data.status,
                        "location": data.locationHref,
                        "target": data.fsTarget,
                        "symlink": data.fsTargetSymLink || '',
                        "extn": data.extn,
                    }]
                });
                accessLogAgGridConfig.columnApi.autoSizeAllColumns();
            } else {
                console.log('accessLogAgGrid not available in log-access');
            }
        });
    </script>
    <script>
        // <ag-grid> web component uses config-eval-js="accessLogAgGridConfig" to define the initial grid
        // and then registerAccessLogAgGrid will set this same variable to final version computed by the WC.
        let accessLogAgGridConfig = {
            gridDefn: {
                defaultColDef: { resizable: true },
                columnDefs: [
                    { field: "date", "sortable": true },
                    { field: "extn", "sortable": true },
                    { field: "status", "sortable": true },
                    { field: "location", "sortable": true },
                    { field: "target", "sortable": true },
                    { field: "symlink", "sortable": true },
                ],
                rowData: []
            },
        }

        // <ag-grid> web component uses in register-grid-hook="registerAccessLogAgGrid" to track instances
        let accessLogAgGrid = undefined;
        const registerAccessLogAgGrid = (grid, gridConfig, gridDomElem) => {
            accessLogAgGrid = grid;
            accessLogAgGridConfig = gridConfig;
        };
    </script>
</head>

<body>
    <main>
        <article>
            <!-- will automatically be set as title by Executive -->
            <header>Access Log</header>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isAccessLoggingEnabled" data-tunnel-ui="auto">
                <label class="form-check-label" for="isAccessLoggingEnabled">Should server-side access logs to be seen
                    here? <mark>Use sparingly</mark> because it's resource intensive. TODO: find out why each entry is being duplicated.</label>
            </div>

            <ag-grid config-eval-js="accessLogAgGridConfig" register-grid-hook="registerAccessLogAgGrid"
                class="ag-theme-balham"></ag-grid>
        </article>
    </main>
</body>

</html>