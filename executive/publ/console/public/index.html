<!DOCTYPE html>
<!-- follow guidelines in README.md, we hide HTML to prevent flash of unstyled content (FOUC) -->
<html lang="en" style="display:none">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="./path.actuate.css" />
    <script src="./path.actuate.js" type="module"></script>
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
</head>

<!-- always use Semantic tags whenever possible (https://html.spec.whatwg.org/multipage/sections.html#the-article-element) -->

<body data-layout="auto">
    <!-- Here is our page's main content, should always be present because the auto-layout engine in Executive will build around it-->
    <main>
        <!-- It contains an article -->
        <article>
            <header>
                <h1>Welcome to the Console</h1>
            </header> <!-- note use of <header> for article now, not page -->

            <div class="row">
                <div class="col-sm-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Environment Variables for Configuration</h5>
                            <p class="card-text">As suggested by our use of 12-factor app guidelines, we <a
                                    href="https://12factor.net/config">store our configuration in the environment</a>
                                whenever possible. Your primary configuration is in <a
                                    href="https://direnv.net/"><code>direnv</code>-managed</a> <a
                                    href="/workspace/editor-redirect/publication/.envrc"><code>.envrc</code></a>.</p>
                            <p>If you need to modify any configurable environment variables in <code>.envrc</code>
                                you'll need to run <code>direnv allow</code> and restart the publication server.
                            </p>
                            <a href="/workspace/editor-redirect/publication/.envrc" class="btn btn-primary">Open
                                <code>.envrc</code></a>
                        </div>
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="project-inspector" class="table mb-0 table-lg">
                                <!-- will be filled in by script -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Renderers</h5>

                    <div id="renderersGrid" class="ag-theme-alpine"></div>
                </div>
            </div>

            <h2>TODO</h2>
            <section class="card">
                <section class="card-body">
                    <pre data-transformable="markdown">
                        ## Essential

                        * Remove `/console` "hardcoding" from each file (have `path.actuate.js` register its "mount point" in each directory)
                        * Implement restart server handler using new user agent bus (UAB) infrastructure
                        * Implement dynamic navigation using `path.ctx.js`. This might work like Deno's `mod.ts` does where
                        we inventory the files in the current path. If it's regular enough, it could be auto-generated on
                        each start of the server or through Taskfile.ts.

                            ```js
                            const pathCtx = {
                                parent: import('../path.ctx.js'), // if it doesn't exist, parent would be undefined (not error?)
                                entries: [
                                    { unit: "x.html" }, // should have just enough for runtime parsing to be possible
                                    { unit: "y.html" }, // follows interface defined for RouteUnit, which is inherited by RouteNode
                                ],
                            };
                            export default pathCtx;
                            ```

                        * Continuously run Lighthouse in Edge/Chrome DevTools to make sure performance is maintained.

                        ## Next

                        * Migrate all legacy `control-panel` pages to rfConsole.
                        * Integrate Deno-specific [Packup](https://github.com/kt3k/packup) packager as Oak routes or use it
                        as guidance.
                        * In `executive/publ/console/mod.ts` make `#isAccessLoggingEnabled` accessible through Console so
                        access logging can be controlled from the browser dynamically.
                        * Create feature flags API endpoint so that unlimited Unleash-like FF's can be integrated
                        * Implement [Oak eTag](https://github.com/oakserver/oak#etag-support) before going to production
                        * Implement [effector.dev](https://effector.dev/) for business logic (with XState for mor complex requirements)

                        ## Components

                        * Check out [Minze](https://minze.dev/guide/introduction.html), Atomico, Tonic, and other lightweight CE frameworks to create our own library and conventions. It's best to not use other frameworks as dependencies.
                        * Use [µhtml](https://github.com/WebReflection/uhtml#readme) for DOM-friendly dynamic rendering.
                        * Use [µce](https://github.com/WebReflection/uce) for µhtml-based Custom Elements.
                        * Use [µce\-template](https://github.com/WebReflection/uce-template#readme) for a Vue 3 inspired Custom Elements toolless alternative.

                        ## Experiment

                        * See [Building data\-centric apps with a reactive relational database](https://riffle.systems/essays/prelude/) for interesting way to use SQLite.
                        ```
                    </pre>
                </section>
            </section>
        </article>
    </main>

    <script type="module">
        import { humanPath } from "./deps.auto.js";

        document.addEventListener('DOMContentLoaded', function () {
            fetch("/publication/inspect/project.json").then(resp => resp.json()).then(project => {
                const table = document.getElementById("project-inspector");
                for (const entry of Object.entries(project)) {
                    const [key, value] = entry;
                    // Create an empty <tr> element and add it to the 1st position of the table:
                    const row = table.insertRow();

                    // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
                    const keyCell = row.insertCell(0);
                    const valueCell = row.insertCell(1);

                    // Add some text to the new cells:
                    keyCell.innerHTML = key;
                    if (typeof value === "object") {
                        switch (value?.nature) {
                            case "path-project":
                                valueCell.innerHTML = humanPath(value.path, 75);
                                valueCell.title = value.path;
                                break;

                            case "file-project":
                                if (value?.isEditable) {
                                    const editorRedirect = `/workspace/editor-redirect/abs${value.file}`;
                                    valueCell.innerHTML = humanPath(value.file, 75, (basename) => `<a href="${editorRedirect}" class="fw-bold">${basename}</a>`);
                                    valueCell.title = editorRedirect;
                                } else {
                                    valueCell.innerHTML = value.file;
                                }
                                break;

                            case "design-system":
                                let src = value.designSystem.location.moduleImportMetaURL;
                                let srcHref = undefined;
                                if (src.startsWith("file://")) {
                                    src = src.substring(7);
                                    const editorRedirect = `/workspace/editor-redirect/abs${src}`;
                                    srcHref = humanPath(src, 50, (basename) => `<a href="${editorRedirect}" class="fw-bold">${basename}</a>`);
                                } else {
                                    srcHref = humanPath(src, 50, (basename) => `<a href="${src}" class="fw-bold">${basename}</a>`);
                                }
                                valueCell.innerHTML = `<span class="fw-bold">${value.designSystem.identity}</span> (${srcHref})`;
                                break;
                            default:
                                valueCell.innerHTML = JSON.stringify(value);
                        }
                    } else {
                        valueCell.innerHTML = value.toString();
                    }
                }
            });

            const renderersGridElem = document.querySelector('#renderersGrid');
            if (renderersGridElem) {
                fetch("/publication/inspect/renderers.json").then(resp => resp.json()).then(renderers => {
                    const columnDefs = [
                        { field: "identity" },
                        {
                            field: "location",
                            cellRenderer: "locationCellRenderer",
                        }
                    ];
                    const gridOptions = {
                        columnDefs: columnDefs,
                        rowData: renderers,
                        domLayout: 'autoHeight',
                        onGridReady: (event) => event.columnApi.autoSizeAllColumns(),
                        components: {
                            // see https://www.ag-grid.com/javascript-grid/components/
                            locationCellRenderer: (params) => {
                                if ("location" in params.data) {
                                    let src = params.data.location.moduleImportMetaURL;
                                    let srcHref = undefined;
                                    if (src.startsWith("file://")) {
                                        src = src.substring(7);
                                        const editorRedirect = `/workspace/editor-redirect/abs${src}`;
                                        srcHref = humanPath(src, 90, (basename) => `<a href="${editorRedirect}" class="fw-bold">${basename}</a>`);
                                    } else {
                                        srcHref = humanPath(src, 90, (basename) => `<a href="${src}" class="fw-bold">${basename}</a>`);
                                    }
                                    return srcHref;
                                }
                                return params.value;
                            },
                        },
                    };
                    new agGrid.Grid(renderersGridElem, gridOptions);
                })
            }
        });
    </script>
</body>

</html>