<!DOCTYPE html>
<!-- follow guidelines in README.md, see FOUC section for why display:none is used-->
<html lang="en" style="display:none">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../path.actuate.css" />
    <!-- $script used by component/ag-grid.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/script.js/2.5.9/script.min.js"></script>
    <script src="/universal-cc/component/ag-grid.js"></script>
    <script type="module">
        import { actuationStrategy, ServiceBus, EventEmitter } from "../path.lib.js";
        // prepare global `executive` and "bootstrap" or _actuate_ the page.
        const strategy = actuationStrategy().args;
        const executive = strategy.actuate();
    </script>
    <script>
        // <ag-grid> web component uses config-eval-js="accessLogAgGridConfig" to define the initial grid
        // and then registerAccessLogAgGrid will set this same variable to final version computed by the WC.
        let accessLogAgGridConfig = {
            gridDefn: {
                defaultColDef: { resizable: true },
                columnDefs: [
                    { field: "created_at", headerName: 'Date', sortable: true },
                    { field: "asset_nature", headerName: 'Nature', sortable: true },
                    { field: "status", headerName: 'Status', sortable: true },
                    { field: "location_href", headerName: 'Location', sortable: true },
                    { field: "filesys_target_path", headerName: 'Target', sortable: true },
                    { field: "filesys_target_symlink", headerName: 'Symlink', sortable: true },
                ],
                rowData: [],
                onGridReady: (event) => event.columnApi.autoSizeAllColumns(),
            },
        }

        // <ag-grid> web component uses in register-grid-hook="registerAccessLogAgGrid" to track instances
        let accessLogAgGrid = undefined;
        const registerAccessLogAgGrid = (grid, gridConfig, gridDomElem) => {
            accessLogAgGrid = grid;
            accessLogAgGridConfig = gridConfig;
            fetchAccessLog();
        };

        async function fetchAccessLog() {
            const response = await fetch('/SQL/unsafe', {
                method: "POST",
                headers: {
                    'Content-type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    // these columns should be an identical match to the expectations in accessLogAgGridConfig.columnDefs
                    SQL: `  SELECT created_at, asset_nature, status, location_href, filesys_target_path, filesys_target_symlink
                              FROM publ_server_static_access_log
                          ORDER BY created_at DESC
                             LIMIT 100`,
                    // rowNature can be "rows" for array of arrays, or "records" for array of objects with keys as column names
                    rowNature: "records"
                })
            });
            const sqlResult = await response.json();
            accessLogAgGridConfig.api.setRowData(sqlResult.records);
            accessLogAgGridConfig.columnApi.autoSizeAllColumns();
        }
    </script>
</head>

<body>
    <main>
        <article>
            <header>
                <h1>Access Log</h1>
            </header>

            <section class="card">
                <ag-grid config-eval-js="accessLogAgGridConfig" register-grid-hook="registerAccessLogAgGrid"
                    class="ag-theme-balham"></ag-grid>
            </section>
        </article>
    </main>
</body>

</html>