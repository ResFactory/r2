<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../path.actuate.css">
    <script>
        const healthJsonLabel = "health.json";
        const healthJsonURL = "/operational-context/observability/health.json";
        const healthJsonAnchor = `<a href="${healthJsonURL}">${healthJsonLabel}</a>`;
    </script>
</head>

<body>
    <details>
        <summary>Environment Variables</summary>

        <p>These are all the environment variables known to the publication server (<code>pubctl.ts</code>)
            including sensitive values without masking. <em>Be careful about copy/pasting this content</em>.
            If you need a "sanitized" version of environment variables, there is a safer copy in
            <script>document.write(healthJsonAnchor)</script> (see
            <code><script>document.write(healthJsonLabel)</script></code>'s <code>build</code> component's
            <code>links</code>).
        </p>
        <div data-populate-fetched-json-url="/workspace/inspect/env-vars.json"></div>
    </details>

    <details>
        <summary>Health</summary>

        <p>
            These are the health checks performed by (<code>pubctl.ts</code>) and stored in
            <script>document.write(healthJsonAnchor)</script>.
        </p>

        <details open>
            <summary>Errors</summary>
            <div id="unhealthy-json-errors"></div>
        </details>

        <details open>
            <summary>Warnings</summary>
            <div id="unhealthy-json-warnings"></div>
        </details>

        <details>
            <summary>health.json</summary>
            <div id="health-json-all"></div>
        </details>

    </details>

    <script type="module">
        import * as path from "../path.actuate.mjs";

        // automatically inject navbars and other site-wide elements
        path.activateSite();

        document.addEventListener('DOMContentLoaded', function () {
            // setup events, stores, and effects listeners so that we can be
            // as decoupled from business logic as possible

            path.pageFetchJsonFx.done.watch(({ params, result: health }) => {
                if (params.fetchURL != healthJsonURL) return;
                const errors = [];
                const warnings = [];
                Object.entries(health.checks).forEach(check => {
                    const [serviceIdentity, components] = check;
                    for (const c of components) {
                        switch (c.status) {
                            case "pass":
                                break;
                            case "warn":
                                warnings.push({ service: serviceIdentity, ...c });
                                break;
                            case "fail":
                                errors.push({ service: serviceIdentity, ...c });
                                break
                        }
                    }
                });
                path.populateObjectJSON(errors, document.querySelector('#unhealthy-json-errors'), 2);
                path.populateObjectJSON(warnings, document.querySelector('#unhealthy-json-warnings'), 2);
                path.populateObjectJSON(health, document.querySelector('#health-json-all'), 2);
            });
            path.pageFetchJsonFx({ fetchURL: healthJsonURL });

            // all listeners are ready so let's activate the page and trigger the watchers
            path.activatePage(path.inspectableClientLayout());
        });
    </script>
</body>

</html>