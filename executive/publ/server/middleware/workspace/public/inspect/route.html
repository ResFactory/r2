<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../path.actuate.css">
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
</head>

<body>
    <p style="font-weight: bolder;">
        <code class="rf-resource-inspectable-active">
            <span render-fx="({ target }) => target.innerHTML = path.editableClientLayoutTarget()?.fileName"
                render-hook-activate-page>
            </span>
        </code>
        Resource Route
    </p>
    <p>A <em>route</em> is the location of a page. Every page, whether it's navigable or hidden, has a route. Each route
        is comprised of one or more <em>route units</em>, which are the component's of the path where the page is
        located.</p>
    <p interpolate-fx="{ result: { inspectableRFUL: { route } } }" render-hook-activate-page>
        <b>${route.terminal?.label}</b> is a <code class="mime-type">${route.nature.mediaType}</code> page at route
        level
        ${route.terminal?.level + 1} and has ${route.units.length} ancestor${route.units.length == 1 ? '' : 's'}.
    </p>
    <p id="revisionSummary" style="padding-top: 5px; padding-bottom: 5px"></p>

    <details class="explore" open>
        <summary>Page Terminal Route Unit</summary>
        <p><code>clientLayout.route.terminal</code> is referred to as the <em>terminal route unit</em> because it
            'terminates' the path where this page is located.</p>
        <div render-fx="({ target, result: { inspectableRFUL: { route } } }) => path.populateObjectJSON(route.terminal, target)"
            render-hook-activate-page></div>
    </details>

    <details class="explore">
        <summary>Page Route</summary>
        <p><code>clientLayout.route</code> is referred to as the <em>route</em> because it describes the full path where
            this page is located. A single route is always comprised of one or more <em>route units</em>. The <em>route
                units</em> can be used to create <em>breadcrumbs</em> in the UI.</p>
        <div render-fx="({ target, result: { inspectableRFUL: { route } } }) => path.populateObjectJSON(route, target)"
            render-hook-activate-page></div>
    </details>

    <details class="explore">
        <summary>Page Version History (Git Commits)</summary>
        <div id="routeGitLog" class="ag-theme-alpine"></div>
    </details>

    <script type="module">
        import * as path from "../path.actuate.mjs";
        import * as srScriptDeps from "../server-runtime-script/deps.auto.js";
        import * as agG from "../aggrid.mjs";

        document.addEventListener('DOMContentLoaded', function () {
            // setup events, stores, and effects listeners so that we can be
            // as decoupled from business logic as possible

            const scriptsInventory = srScriptDeps.typicalScriptsInventory();
            const routeGitLogFx = path.prepareFetchServerRuntimeScriptJsonEffect(
                scriptsInventory.script('typicalScripts_version-control_git-log-active-route.js.json'),
                path.routeUrlSearchParams(path.inspectableClientLayout().route.terminal)
            );

            const $routeGitLog = path.pageDomain.createStore([]);
            $routeGitLog.on(routeGitLogFx.doneData, (_, routeGitLog) => routeGitLog);
            $routeGitLog.watch((routeGitLog) => {
                if (routeGitLog.length > 0) {
                    const authors = [...new Set(routeGitLog.map(entry => entry.authorName))];
                    const author = (entry) => { return `<b>${routeGitLog[entry].authorName}</b> <i>${path.timeSince(new Date(routeGitLog[entry].authorDate))} ago</i>` }
                    document.getElementById("revisionSummary").innerHTML =
                        `Created by ${author(routeGitLog.length - 1)}, last modified by ${author(0)} (${routeGitLog.length} total commits by ${authors.length} author${authors.length > 1 ? 's' : ''})`;
                }
                agG.populateAgGrid(agGrid, document.getElementById("routeGitLog"), (agGridOptionsGen) => {
                    return agGridOptionsGen({
                        columnDefs: [
                            { field: "subject" },
                            { field: "authorName" },
                            { field: "authorDate" }
                        ],
                        rowData: routeGitLog
                    });
                })
            });

            // check all the DOM elements to see if any events, stores, or effects
            // want to "hook" into the Effector instances; assume all domEffects'
            // eval()'s are done in this visiblity context
            path.prepareDomEffects({ evalJS: (js) => eval(js) });

            // all listeners are ready so let's activate the page and trigger the watchers
            path.activatePageFx();
            routeGitLogFx();
        });
    </script>
</body>

</html>