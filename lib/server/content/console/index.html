<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/script.js/2.5.9/script.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./executive.css" />
    <script src="/universal-cc/component/ag-grid.js"></script>
    <script type="module" src="./executive.js"></script>
    <script>
        document.addEventListener('executive-after-init', function (e) {
            $script("/universal-cc/script/socket-command.js", () => {
                socketCmdsMgrVisualsProseDecorator(new SocketCommandsManager(
                    `ws://${document.location.host}/experimental-server/console/ws`,
                    new EventEmitterSocketCommandsHandler(document, "tunnel-"),
                    { diagnose: false })
                ).connect(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const open = urlParams.get('open');
                    if (open) {
                        window.open(open, urlParams.get('open-target')).focus();
                    }
                });
            });
        }, false);

        // <ag-grid> web component uses config-eval-js="accessLogAgGridConfig" to define the initial grid
        // and then registerAccessLogAgGrid will set this same variable to final version computed by the WC.
        let accessLogAgGridConfig = {
            gridDefn: {
                defaultColDef: { resizable: true },
                columnDefs: [
                    { field: "date", "sortable": true },
                    { field: "extn", "sortable": true },
                    { field: "status", "sortable": true },
                    { field: "location", "sortable": true },
                    { field: "target", "sortable": true },
                    { field: "symlink", "sortable": true },
                ],
                rowData: []
            },
        }

        // <ag-grid> web component uses in register-grid-hook="registerAccessLogAgGrid" to track instances
        let accessLogAgGrid = undefined;
        const registerAccessLogAgGrid = (grid, gridConfig, gridDomElem) => {
            accessLogAgGrid = grid;
            accessLogAgGridConfig = gridConfig;
        };

        // tunnel-log-access is a custom event emitted by SocketCommandsManager's EventEmitterSocketCommandsHandler
        document.addEventListener('tunnel-log-access', function (e) {
            if (accessLogAgGrid) {
                const data = e.detail.commandArgs;
                accessLogAgGridConfig.api.applyTransaction({
                    add: [{
                        "date": new Date().toISOString(),
                        "status": data.status,
                        "location": data.locationHref,
                        "target": data.fsTarget,
                        "symlink": data.fsTargetSymLink || '&nbsp;',
                        "extn": data.extn,
                    }]
                });
                accessLogAgGridConfig.columnApi.autoSizeAllColumns();
            } else {
                console.log('accessLogAgGrid not available in tunnel-log-access', e);
            }
        }, false);

        /**
         * Uses https://github.com/Alorel/console-log-html to redirect console.* output to an HTML DOM element.
         * @param {*} redirectConsoleContainerID
         */
        // deno-lint-ignore no-unused-vars
        const redirectConsoleToHTML = (redirectConsoleContainerID = "container_redirectConsole") => {
            const consoleLogWarningStyles = `
                color: #fff;
                background-color: #c23934;
                display: block;
                text-align: center;
                padding: 8px 32px;
                font: 100 16px/28px sans-serif;
                background-image: linear-gradient(45deg,rgba(0,0,0,.025) 25%,transparent 25%,transparent 50%,rgba(0,0,0,.025) 50%,rgba(0,0,0,.025) 75%,transparent 75%,transparent);
                background-size: 64px 64px;
            `;

            const ldsRedirectConsoleContainer = document.getElementById(redirectConsoleContainerID);
            if (ldsRedirectConsoleContainer) {
                $script(
                    "//cdn.rawgit.com/Alorel/console-log-html/master/console-log-html.min.js",
                    function () {
                        ConsoleLogHTML.connect(ldsRedirectConsoleContainer);
                        console.log(`Alorel/console-log-html Ready.`);
                    },
                );
            } else {
                console.log(
                    "%c%s",
                    consoleLogWarningStyles,
                    `Element with ID '${redirectConsoleContainerID}' required by redirectConsoleToHTML() does not exist.`,
                );
            }

            document.addEventListener('tunnel-log', function (e) {
                console.log(e.detail.commandArgs);
            }, false);

            document.addEventListener('tunnel-error', function (e) {
                console.error(e.detail.commandArgs);
            }, false);
        };
    </script>
</head>

<body>
    <site-body-head></site-body-head>

    <div class="container-fluid m-3">
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-access-log-tab" data-bs-toggle="tab"
                    data-bs-target="#nav-access-log" type="button" role="tab" aria-controls="nav-access-log"
                    aria-selected="true">Access Log</button>
                <button class="nav-link" id="nav-diagnostics-tab" data-bs-toggle="tab" data-bs-target="#nav-diagnostics"
                    type="button" role="tab" aria-controls="nav-diagnostics" aria-selected="false">Diagnostics</button>
                <button class="nav-link" id="nav-universal-state-tab" data-bs-toggle="tab"
                    data-bs-target="#nav-universal-state" type="button" role="tab" aria-controls="nav-universal-state"
                    aria-selected="false">State</button>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-access-log" role="tabpanel"
                aria-labelledby="nav-access-log-tab">
                <ag-grid config-eval-js="accessLogAgGridConfig" register-grid-hook="registerAccessLogAgGrid"
                    class="ag-theme-balham"></ag-grid>
            </div>
            <div class="tab-pane fade" id="nav-diagnostics" role="tabpanel" aria-labelledby="nav-diagnostics-tab">
                <ul id="container_redirectConsole">

                </ul>
            </div>
            <div class="tab-pane fade" id="nav-universal-state" role="tabpanel"
                aria-labelledby="nav-universal-state-tab">...</div>
        </div>
    </div>

    <site-body-tail></site-body-tail>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            redirectConsoleToHTML();
        });
    </script>
</body>

</html>