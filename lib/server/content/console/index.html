<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link href="https://cdnjs.cloudflare.com" crossorigin>
    <link href="//cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css" rel="stylesheet">

    <script src="/universal-cc/script/socket-command.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="./images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon/favicon-16x16.png">
    <link rel="manifest" href="./images/favicon/site.webmanifest">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/script.js/2.5.9/script.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <style>
        /*Overrides for Tailwind CSS */

        /*Form fields*/
        .dataTables_wrapper select,
        .dataTables_wrapper .dataTables_filter input {
            color: #4a5568;
            /*text-gray-700*/
            padding-left: 1rem;
            /*pl-4*/
            padding-right: 1rem;
            /*pl-4*/
            padding-top: .5rem;
            /*pl-2*/
            padding-bottom: .5rem;
            /*pl-2*/
            line-height: 1.25;
            /*leading-tight*/
            border-width: 2px;
            /*border-2*/
            border-radius: .25rem;
            border-color: #edf2f7;
            /*border-gray-200*/
            background-color: #edf2f7;
            /*bg-gray-200*/
        }

        /*Row Hover*/
        table.dataTable.hover tbody tr:hover,
        table.dataTable.display tbody tr:hover {
            background-color: #ebf4ff;
            /*bg-indigo-100*/
        }

        /*Pagination Buttons*/
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            font-weight: 700;
            /*font-bold*/
            border-radius: .25rem;
            /*rounded*/
            border: 1px solid transparent;
            /*border border-transparent*/
        }

        /*Pagination Buttons - Current selected */
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            color: #fff !important;
            /*text-white*/
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);
            /*shadow*/
            font-weight: 700;
            /*font-bold*/
            border-radius: .25rem;
            /*rounded*/
            background: #667eea !important;
            /*bg-indigo-500*/
            border: 1px solid transparent;
            /*border border-transparent*/
        }

        /*Pagination Buttons - Hover */
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: #fff !important;
            /*text-white*/
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);
            /*shadow*/
            font-weight: 700;
            /*font-bold*/
            border-radius: .25rem;
            /*rounded*/
            background: #667eea !important;
            /*bg-indigo-500*/
            border: 1px solid transparent;
            /*border border-transparent*/
        }

        /*Add padding to bottom border */
        table.dataTable.no-footer {
            border-bottom: 1px solid #e2e8f0;
            /*border-b-1 border-gray-300*/
            margin-top: 0.75em;
            margin-bottom: 0.75em;
        }

        /*Change colour of responsive icon*/
        table.dataTable.dtr-inline.collapsed>tbody>tr>td:first-child:before,
        table.dataTable.dtr-inline.collapsed>tbody>tr>th:first-child:before {
            background-color: #667eea !important;
            /*bg-indigo-500*/
        }
    </style>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <nav id="header" class="fixed w-full z-10 top-0">
        <div id="progress" class="h-1 z-20 top-0"
            style="background:linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0);"></div>

        <div class="w-full md:max-w-4xl mx-auto flex flex-wrap items-center justify-between mt-0 py-3">
            <div class="pl-4">
                <a class="text-gray-900 text-base no-underline hover:no-underline font-extrabold text-xl" id="page-head"
                    href="#">
                    Resource Factory Console
                </a>
            </div>
            <div class="pl-2">
                <img id="socket-commands-mgr-state-visuals" src="./images/websocket-logo-300x225px-transpbg.png"
                    style="height:15px; display:none">
            </div>

            <div class="block lg:hidden pr-4">
                <button id="nav-toggle"
                    class="flex items-center px-3 py-2 border rounded text-gray-500 border-gray-600 hover:text-gray-900 hover:border-green-500 appearance-none focus:outline-none">
                    <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <title>Menu</title>
                        <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z" />
                    </svg>
                </button>
            </div>

            <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block mt-2 lg:mt-0 bg-gray-100 md:bg-transparent z-20"
                id="nav-content">
                <ul class="list-reset lg:flex justify-end flex-1 items-center list-none">
                    <li class="mr-3">
                        <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-2 px-4"
                            href="/control-panel/observability/health.json" target="observability">health.json</a>
                    </li>
                    <li class="mr-3">
                        <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-2 px-4"
                            href="/control-panel/observability/metrics.txt" target="observability">metrics.txt</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container w-full mx-auto pt-20">
        <h1 class="text-2xl font-normal leading-normal mt-0 mb-2 text-pink-800 pt-6">Console Output</h1>
        <div id='recipients' class="p-8 mt-6 lg:mt-0 rounded shadow bg-white">
            <ul id="container_redirectConsole">
            </ul>
            This container will report all <code>console.*</code> messages. See <a
                href="https://github.com/Alorel/console-log-html">github.com/Alorel/console-log-html</a> for
            usage instructions.
        </div>

        <h1 class="text-2xl font-normal leading-normal mt-0 mb-2 text-pink-800 pt-6">Access Log</h1>
        <div id='recipients' class="p-8 mt-6 lg:mt-0 rounded shadow bg-white">
            <table id="access-log" class="stripe hover">
                <thead>
                    <tr>
                        <th data-priority="1">Date</th>
                        <th data-priority="2">Status</th>
                        <th data-priority="3">Location</th>
                        <th data-priority="4">Target</th>
                        <th data-priority="5">Target SymLink</th>
                        <th data-priority="5">Extn</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="py-8"></div>

    <footer class="bg-white border-t border-gray-400 shadow">
        <div class="container max-w-6xl mx-auto flex py-8">
            <div class="w-full mx-auto flex flex-wrap">
                <div class="flex w-full md:w-1/2">
                    <div class="px-8">
                        <h3 class="font-bold text-gray-900">Socket Commands Status</h3>
                        <p id="socket-commands-mgr-state-prose" class="py-4 text-gray-600 text-sm">
                            If you see this message it means that the websocket connection did not initiate.
                            Try restarting your browser?
                        </p>
                    </div>
                </div>

                <div class="flex w-full md:w-1/2">
                    <div class="px-8">
                        <h3 class="font-bold text-gray-900">Observability artifacts</h3>
                        <ul class="list-reset items-center text-sm pt-3 list-none">
                            <li>
                                <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-1"
                                    href="/control-panel/observability/health.json" target="observability">
                                    View <code>health.json</code>
                                </a>
                            </li>
                            <li>
                                <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-1"
                                    href="/control-panel/observability/metrics.json" target="observability">
                                    View <code>metrics.json</code>
                                </a>
                            </li>
                            <li>
                                <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-1"
                                    href="/control-panel/observability/metrics.txt" target="observability">
                                    View Exported OpenMetrics (in Prometheus Exposition Format)
                                </a>
                            </li>
                            <li>
                                <a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:text-underline py-1"
                                    href="/control-panel/observability/analytics-paths-extensions.csv"
                                    target="observability">
                                    Open origin and assets analytics (CSV)
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</body>

<!-- datatables.net dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="//cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
<script>
    "use strict";

    function parseHttpHeaders(httpHeaders) {
        return httpHeaders.split("\n")
            .map(x => x.split(/: */, 2))
            .filter(x => x[0])
            .reduce((ac, x) => { ac[x[0]] = x[1]; return ac; }, {});
    }

    // generally all console pages should use relative paths;
    // rfExprServerConsoleBaseURL should be used when absolute paths are required
    var rfExprServerConsoleBaseURL = null;
    const inspectHeadersXHR = new XMLHttpRequest();
    inspectHeadersXHR.open("HEAD", location);
    inspectHeadersXHR.send();
    inspectHeadersXHR.onload = function () {
        const headers = parseHttpHeaders(inspectHeadersXHR.getAllResponseHeaders());
        rfExprServerConsoleBaseURL = headers["rf-console-html-base-url"];
        const ph = document.getElementById("page-head");
        if (ph) ph.href = rfExprServerConsoleBaseURL;
    }

    socketCmdsMgrVisualsProseDecorator(new SocketCommandsManager(
        `ws://${document.location.host}/experimental-server/console/ws`,
        new NamedSocketCommandsHandler({
            "log-access": (commandID, commandArgs, event) => {
                const { status, locationHref, fsTarget, fsTargetSymLink, extn } = commandArgs;
                accessLogDataTable.row.add([new Date().toISOString(), status, locationHref, fsTarget, fsTargetSymLink || '&nbsp;', extn]).draw().node();
            },
            "reload": (commandID, commandArgs, event) => {
                location.reload();
            },
            "log": (commandID, commandArgs, event) => {
                console.log(commandArgs);
            },
            "error": (commandID, commandArgs, event) => {
                console.error(commandArgs);
            }
        }), { diagnose: true })).connect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const open = urlParams.get('open');
            if (open) {
                window.open(open, urlParams.get('open-target')).focus();
            }
        });


    const accessLogTableID = 'access-log';
    let accessLogDataTable; // will be initialized after document is loaded

    const consoleLogWarningStyles = `
        color: #fff;
        background-color: #c23934;
        display: block;
        text-align: center;
        padding: 8px 32px;
        font: 100 16px/28px sans-serif;
        background-image: linear-gradient(45deg,rgba(0,0,0,.025) 25%,transparent 25%,transparent 50%,rgba(0,0,0,.025) 50%,rgba(0,0,0,.025) 75%,transparent 75%,transparent);
        background-size: 64px 64px;
    `;

    /**
     * Uses https://github.com/Alorel/console-log-html to redirect console.* output to an HTML DOM element.
     * @param {*} redirectConsoleContainerID
     */
    // deno-lint-ignore no-unused-vars
    const redirectConsoleToHTML = (
        redirectConsoleContainerID = "container_redirectConsole",
    ) => {
        const ldsRedirectConsoleContainer = document.getElementById(redirectConsoleContainerID);
        if (ldsRedirectConsoleContainer) {
            $script(
                "//cdn.rawgit.com/Alorel/console-log-html/master/console-log-html.min.js",
                function () {
                    ConsoleLogHTML.connect(ldsRedirectConsoleContainer);
                    console.log(`Ready.`);
                },
            );
        } else {
            console.log(
                "%c%s",
                consoleLogWarningStyles,
                `Element with ID '${redirectConsoleContainerID}' required by redirectConsoleToHTML() does not exist.`,
            );
        }
    };

    //Javascript to toggle the menu
    document.getElementById('nav-toggle').onclick = function () {
        document.getElementById("nav-content").classList.toggle("hidden");
    }

    document.addEventListener('DOMContentLoaded', function () {
        accessLogDataTable = new DataTable(`#${accessLogTableID}`, {
            pageLength: 100,
            language: {
                emptyTable: "No server accesses logged, refresh a content page to see data here."
            },
            columnDefs: [{
                targets: [0, 1, 2, 3, 4, 5],
                createdCell: function (td, cellData, rowData, row, col) {
                    const status = rowData[1];
                    const extn = rowData[5];
                    if (status == 200 && extn == ".html") {
                        $(td).css('font-weight', 'bold')
                    }
                    if (status == 304) {
                        $(td).css('color', 'gray')
                    }
                }
            }],
        });

        /* Progress bar */
        //Source: https://alligator.io/js/progress-bar-javascript-css-variables/
        var h = document.documentElement,
            b = document.body,
            st = 'scrollTop',
            sh = 'scrollHeight',
            progress = document.querySelector('#progress'),
            scroll;
        var scrollpos = window.scrollY;
        var header = document.getElementById("header");
        var navcontent = document.getElementById("nav-content");

        document.addEventListener('scroll', function () {
            /*Refresh scroll % width*/
            scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
            progress.style.setProperty('--scroll', scroll + '%');

            /*Apply classes for slide in bar*/
            scrollpos = window.scrollY;

            if (scrollpos > 10) {
                header.classList.add("bg-white");
                header.classList.add("shadow");
                navcontent.classList.remove("bg-gray-100");
                navcontent.classList.add("bg-white");
            } else {
                header.classList.remove("bg-white");
                header.classList.remove("shadow");
                navcontent.classList.remove("bg-white");
                navcontent.classList.add("bg-gray-100");
            }
        });

        redirectConsoleToHTML();
    });
</script>

</html>